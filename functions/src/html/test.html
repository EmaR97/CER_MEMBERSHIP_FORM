<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/willowsystems/jSignature/master/libs/jSignature.min.js"></script>
    <script type="text/javascript">
        $(function () {
            // Initialize signature pad on modal open.
            let $signaturePad = $("#signaturePad");
            let signatureAPI = $signaturePad.jSignature({
                'decor-color': 'transparent',
                'width': "235px",
                'height': "100px",
                'lineWidth': 1
            });

            // Helper function to convert a data URL to a File object.
            function dataURLtoFile(dataurl, filename) {
                const arr = dataurl.split(',');
                const mimeMatch = arr[0].match(/:(.*?);/);
                if (!mimeMatch) {
                    throw new Error("Invalid data URL");
                }
                const mime = mimeMatch[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], filename, {type: mime});
            }

            // Function to open the modal.
            function openSignatureModal(signatureParent) {
                // Store a reference to the target preview image (inside the signature container)
                const $targetImg = signatureParent.find('.signature-preview');

                // Clear previous signature data from the modal
                signatureAPI.jSignature("reset");
                $("#signatureFileInput").val('');

                // Show the modal (for simplicity, using jQuery show/hide; you could use Bootstrapâ€™s modal('show'))
                $("#signatureModal").fadeIn(200);

                // --- Button Handlers ---

                // Save button: capture the jSignature canvas
                $("#saveSignature").off('click').on('click', function () {
                    const imageDataArray = signatureAPI.jSignature("getData", "image");
                    if (Array.isArray(imageDataArray) && imageDataArray.length > 1) {
                        const mimeType = imageDataArray[0];
                        const base64Data = imageDataArray[1];
                        const imageDataUrl = `data:${mimeType},${base64Data}`;
                        // Optionally create a File object if you need to submit with a form (using a DataTransfer trick)
                        try {
                            const signatureFile = dataURLtoFile(imageDataUrl, 'signature.png');
                            // If you want to update an actual file input outside the modal, you can do so here.
                            // For now, update the preview image.
                            $targetImg.attr("src", imageDataUrl);
                        } catch (error) {
                            console.error('Error converting signature:', error);
                        }
                    } else {
                        console.warn('No signature data available in canvas.');
                    }
                    $("#signatureModal").fadeOut(200);
                });

                // Clear button: clear the canvas signature and file input
                $("#clearSignature").off('click').on('click', function () {
                    signatureAPI.jSignature("reset");
                    $("#signatureFileInput").val('');
                });

                // Upload button: use the selected file instead of the canvas signature.
                $("#uploadSignature").off('click').on('click', function () {
                    const file = $("#signatureFileInput")[0].files[0];
                    if (!file) {
                        alert("Please select an image file first.");
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        const dataURL = event.target.result;
                        // Update the preview image
                        $targetImg.attr("src", dataURL);
                    };
                    reader.readAsDataURL(file);
                    $("#signatureModal").fadeOut(200);
                });

                // Allow modal close via close button (if needed)
                $(".close-modal").off('click').on('click', function () {
                    $("#signatureModal").fadeOut(200);
                });
            }

            // Open the modal when user clicks the "Sign Here" button
            $(".open-signature-modal").on('click', function () {
                // Find the closest signature container (you can adjust if your layout differs)
                const $signatureContainer = $(this).closest('.signature-container');
                openSignatureModal($signatureContainer);
            });
        });

    </script>
</head>
<body>
<form id="form1">
    <!-- Signature parent element in the page -->
    <div class="signature-container">
        <!-- This img element will later receive the signature image -->
        <img alt="Signature Preview" class="signature-preview" src=""
             style="width:235px; height:100px; border:1px solid #ccc;">
        <!-- Button to open the signature modal -->
        <button class="open-signature-modal" type="button">Sign Here</button>
    </div>

    <!-- Modal for signature capture -->
    <div class="modal" id="signatureModal" role="dialog" style="display:none;" tabindex="-1">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Capture Signature</h5>
                    <button aria-label="Close" class="close close-modal" type="button">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- jSignature canvas placeholder -->
                    <div id="signaturePad" style="border:1px solid #ccc; width:235px; height:100px;"></div>
                    <!-- File input for uploading signature image -->
                    <div style="margin-top:10px;">
                        <input accept=".jpg,.jpeg,.png" id="signatureFileInput" type="file">
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- Button 1: Save the canvas signature -->
                    <button id="saveSignature" type="button">Save Signature</button>
                    <!-- Button 2: Clear the canvas -->
                    <button id="clearSignature" type="button">Clear</button>
                    <!-- Button 3: Load image from file input -->
                    <button id="uploadSignature" type="button">Load Image</button>
                </div>
            </div>
        </div>
    </div>

</form>
</body>
</html>
