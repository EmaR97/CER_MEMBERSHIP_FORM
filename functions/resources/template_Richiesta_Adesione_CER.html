<html lang="en">
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <title>template_Richiesta_Adesione_CER</title>
    <style>
        @media print {
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                box-shadow: none;
            }

            .pdf-page {
                margin: 0
            }

            header, footer, input[type="file"], button {
                display: none;
            }
        }

        body {
            background-color: #f5f5dc;
            margin: 0;
            font-family: sans-serif;
        }

        .pdf-page {
            position: relative;
            margin: 20px auto;
            width: 100%;
            max-width: 800px;
            min-width: 800px;
            height: 1120px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
        }

        .pdf-page img {
            width: 100%;
        }

        #pod-code {
            position: absolute;
            font-size: x-large;
            letter-spacing: 27px;
            justify-content: flex-start;
            width: 550px;
            height: 38px;
            background-color: rgba(0, 0, 0, 0);
            padding-left: 12px;
            left: 0;
            border: none;
            outline: none;
            box-sizing: border-box;
        }

        .overlay {
            height: 20px;
            position: absolute;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #aaa;
            color: #000;
            pointer-events: auto; /* Enable interaction */
            cursor: text;
        }

        .overlay[disabled] {
            color: #666;
            background-color: rgba(200, 200, 200, 0.3); /* Light gray */
            border: 2px dashed #aaa;
            pointer-events: none;
            cursor: not-allowed;
        }

        input[required] {
            pointer-events: auto;
        }

        input[disabled] {
            pointer-events: none;
        }

        input[type="radio"].square-radio {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 2px; /* Make it square */
            cursor: pointer;
        }

        /* Add square check when selected */
        input[type="radio"].square-radio:checked::before {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: black;
        }

        .form-buttons button {
            width: 100px;
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            color: white;
            border: none;
            border-radius: 5px;
        }

        #submit-form {
            background-color: green;
        }

        #clear-form {
            background-color: darkred;
        }

        #submit-form:hover {
            background-color: #45a049;
        }

        #clear-form:hover {
            background-color: red;
        }

        .form-buttons button:focus {
            outline: none;
        }

        .signature canvas {
            background-color: rgba(170, 170, 170, 0.15);
            border: 2px dashed #007BFF;
            border-radius: 4px;
        }
    </style>
    <script>
        const toggleDisabledFieldsOnChange = (radioName, valueToCheck, fieldNames, onChange = false) => {
            const fields = fieldNames.flatMap(name => Array.from(document.querySelectorAll(`input[name="${name}"]`)));
            const handleChange = (radio) => {
                const shouldDisable = radio.value === valueToCheck && radio.checked;
                fields.forEach(field => field.toggleAttribute("disabled", !shouldDisable));
            };
            document.querySelectorAll(`input[name="${radioName}"]`).forEach(radio => {
                if (onChange) radio.addEventListener("change", () => handleChange(radio));
                else handleChange(radio);
            });
        };

        const toggleDisabledFieldsOnChangeAll = (onChange = false) => {
            const conditions = [
                {
                    name: 'user-type',
                    value: 'company',
                    fields: ['comp-role', 'comp-addr', 'comp-name', 'comp-fiscal-code', 'vat', 'pec', 'comp-email', 'comp-phone-number', 'chamber-doc']
                },
                {name: 'role-check', value: 'other', fields: ['other-role']},
                {
                    name: 'e-addr-same-res',
                    value: 'no',
                    fields: ['e-addr-city', "e-addr-prov", "e-addr-street", "e-addr-num"]
                },
                {
                    name: 'existing-plant',
                    value: 'yes',
                    fields: ['connection-date-year', "connection-date-month", "peak-power", "active-conventions", "active-conventions-list", "electricity-bill-prod"]
                },
                {name: 'active-conventions', value: 'yes', fields: ["active-conventions-list"]},
                {name: 'want-plant', value: 'yes', fields: ["available-surface"]}
            ];

            conditions.forEach(({name, value, fields}) => toggleDisabledFieldsOnChange(name, value, fields, onChange));
        };

        document.addEventListener("DOMContentLoaded", () => toggleDisabledFieldsOnChangeAll(true));


    </script>
    <script>
        const storeInputData = (key, value) => {
            if (value !== '') {
                sessionStorage.setItem(key, value)
            }
        };

        const emptyInputData = (key) => sessionStorage.removeItem(key);

        const loadIinputData = (key) => sessionStorage.getItem(key);

        function saveFormToSession(form) {
            form?.querySelectorAll("input").forEach(input => {
                const {id, type, checked, name, value} = input;
                if (type === "file") {
                    return; // Ignore file inputs
                }

                if (type === "checkbox") {
                    checked ? storeInputData(id, "true") : emptyInputData(id);
                } else if (type === "radio" && checked) {
                    form.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                        emptyInputData(radio.name);
                    });
                    storeInputData(name, value);
                } else if (type !== "checkbox" && type !== "radio") {
                    storeInputData(name, value);
                }
            });
        }

        function loadFormFromSession(form) {
            form?.querySelectorAll("input").forEach(input => {
                if (input.type === "file") {
                    return; // Ignore file inputs
                }
                const value = loadIinputData(input.name);
                if (input.type === "checkbox") {
                    input.checked = value === "true";
                } else if (input.type === "radio") {
                    input.checked = loadIinputData(input.name) === input.value;
                } else if (value) {
                    input.value = value;
                }
            });
            toggleDisabledFieldsOnChangeAll()
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("membership-form");

            // Load session data when the DOM is ready
            loadFormFromSession(form);

            // Save session data when the form changes
            form?.addEventListener("change", () => {
                saveFormToSession(form);
            });
        });
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/willowsystems/jSignature/master/libs/jSignature.min.js"></script>
    <script>
        function initSignaturePad(signatureContainer) {
            const image = $(signatureContainer).find("img");
            const containerSelector = $(signatureContainer).find("div");
            const fileInputSelector = $(signatureContainer).find("input");
            const clearButtonSelector = $(signatureContainer).find("button");

            const $sig = containerSelector.jSignature({
                'decor-color': 'transparent',
                'width': "235px",
                'height': "100px",
                'lineWidth': 1,  // Adjust this value to make the cursor smaller

            });

            clearButtonSelector.click(() => {
                $sig.jSignature("reset");
                containerSelector.show();
                image.hide();
                fileInputSelector.val(''); // Clears the file input
                console.log(`clearButtonSelector cleared`);
            });


            fileInputSelector.on('change', function (e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (event) {
                    const dataURL = event.target.result;
                    console.log('File loaded, setting image source...');
                    containerSelector.hide();
                    image.attr("src", dataURL).show();
                    console.log(`containerSelector image loaded`);
                };
                reader.readAsDataURL(file);
            });
        }

        $(function () {
            initSignaturePad("#signature-parent-1");
            initSignaturePad("#signature-parent-2");
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('clear-form').addEventListener('click', () => {
                document.getElementById('membership-form').reset();
                sessionStorage.clear();
            });

            document.getElementById('submit-form').addEventListener('click', () => {
                handleSubmit();

            });
        });

        function handleSubmit() {
            let valid = true;
            let firstInvalidInput = null;

            document.querySelectorAll('#membership-form input').forEach(i => {
                if (!i.disabled && i.required && !i.value.trim()) {
                    i.classList.add('invalid');
                    valid = false;
                    if (!firstInvalidInput) {
                        firstInvalidInput = i; // Store the first invalid input
                    }
                } else {
                    i.classList.remove('invalid');
                }
            });

            if (!valid) {
                firstInvalidInput.focus(); // Focus on the first invalid input
                return;
            }

            generatePDFAndSubmit();
        }


        const opt = {html2canvas: {scale: 2}};

        function generatePDFAndSubmit() {
            $('button').hide();
            $('.pdf-page').css({margin: 0, 'box-shadow': 'none'});

            html2pdf().set(opt).from(document.body).outputPdf('blob').then(blob => {
                const file = new File([blob], 'page.pdf', {type: 'application/pdf'});
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('pdf-upload').files = dt.files;

                $('button').show();
                $('.pdf-page').css({
                    margin: '20px auto',
                    'box-shadow': '0 0 8px rgba(0,0,0,0.2)'
                });
                // document.getElementById('membership-form').submit();
            });
        }
    </script>
</head>
<body>
<form id="membership-form" style="margin-bottom: 80px" action="your-server-url-here" method="POST">
    <div class="pdf-page">
        <img alt="PDF Page 1" src="./template_Richiesta_Adesione_CER_files/page001.jpg">
        <input class="overlay" name="name" required style="top: 219px;left: 193px;width: 523px;">
        <input class="overlay" name="birthplace-city" required style="top: 266px;left: 130px;width: 290px;">
        <input class="overlay" name="birthplace-prov" required style="top: 266px;left: 460px;width: 42px;">
        <input class="overlay" name="birthdate" required style="top: 266px;left: 520px;width: 200px;" type="date">
        <input class="overlay" name="residence-city" required style="top: 314px;left: 163px;width: 105px;">
        <input class="overlay" name="residence-prov" required style="top: 314px;left: 309px;width: 45px;">
        <input class="overlay" name="residence-street" required style="top: 314px;left: 395px;width: 258px;">
        <input class="overlay" name="residence-num" required style="top: 314px;left: 672px;width: 50px;" type="number">
        <input class="overlay" name="fiscal-code" required style="top: 362px;left: 146px;width: 576px;">
        <input class="overlay" name="phone-number" required style="top: 410px;left: 100px;width: 225px;" type="tel">
        <input class="overlay" name="email" required style="top: 410px;left: 376px;width: 349px;" type="email">
        <input class="overlay square-radio" name="user-type" required style="top: 458px;left: 197px;" type="radio"
               value="person">
        <input class="overlay square-radio" name="user-type" required style="top: 458px;left: 340px;" type="radio"
               value="company">
        <input class="overlay" name="comp-role" required style="top: 564px;left: 245px;width: 258px;">
        <input class="overlay" name="comp-addr" required style="top: 611px;left: 77px;width: 645px;">
        <input class="overlay" name="comp-name" required style="top: 658px;left: 152px;width: 291px;">
        <input class="overlay" name="comp-fiscal-code" required style="top: 658px;left: 545px;width: 176px;">
        <input class="overlay" name="vat" required style="top: 706px;left: 152px;width: 186px;">
        <input class="overlay" name="pec" required style="top: 706px;left: 374px;width: 349px;" type="email">
        <input class="overlay" name="comp-email" required style="top: 753px;left: 100px;width: 233px;" type="email">
        <input class="overlay" name="comp-phone-number" required style="top: 753px;left: 382px;width: 343px;"
               type="tel">
    </div>
    <div class="pdf-page">
        <img alt="PDF Page 2" src="./template_Richiesta_Adesione_CER_files/page002.jpg">
        <input class="overlay square-radio" name="role-check" required style="top: 311px;left: 91px;" type="radio"
               value="consumer">
        <input class="overlay square-radio" name="role-check" required style="top: 340px;left: 91px;" type="radio"
               value="producer">
        <input class="overlay square-radio" name="role-check" required style="top: 369px;left: 91px;" type="radio"
               value="prosumer">
        <input class="overlay square-radio" name="role-check" required style="top: 418px;left: 91px;" type="radio"
               value="other">
        <input class="overlay" name="other-role" required style="top: 418px;left: 237px;width: 488px;">
        <div class="overlay" required style="top: 540px; left: 180px;width: 524px;padding: 18px 0 18px 0;">
            <input id="pod-code" name="pod-code" required>
        </div>
        <input class="overlay" name="type" required style="top: 663px;left: 100px;width: 346px;">
        <input class="overlay" name="committed-power" required style="top: 663px;left: 618px;width: 67px;">
        <input class="overlay square-radio" name="e-addr-same-res" required
               style="top: 704px;left: 342px;" type="radio" value="yes">
        <input class="overlay square-radio" name="e-addr-same-res" required
               style="top: 704px;left: 483px;" type="radio" value="no">
        <input class="overlay" name="e-addr-city" required style="top: 732px;left: 186px;width: 106px;">
        <input class="overlay" name="e-addr-prov" required style="top: 732px;left: 332px;width: 26px;">
        <input class="overlay" name="e-addr-street" required style="top: 732px;left: 401px;width: 266px;">
        <input class="overlay" name="e-addr-num" required style="top: 732px;left: 686px;width: 36px;" type="number">
        <input class="overlay" name="foglio" style="top: 787px;left: 171px;width: 72px;">
        <input class="overlay" name="particella" style="top: 787px;left: 311px;width: 72px;">
        <input class="overlay" name="subalterno" style="top: 787px;left: 462px;width: 72px;">
        <input class="overlay" name="f1-usage" style="top: 847px;left: 274px;width: 66px;" type="number">
        <input class="overlay" name="f2-usage" style="top: 847px;left: 403px;width: 66px;" type="number">
        <input class="overlay" name="f3-usage" style="top: 847px;left: 144px;width: 66px;" type="number">
        <input class="overlay" name="total-usage" style="top: 847px;left: 604px;width: 66px;" type="number">
        <input class="overlay square-radio" name="existing-plant" required style="top: 892px;left: 556px;" type="radio"
               value="no">
        <input class="overlay square-radio" name="existing-plant" required style="top: 892px;left: 636px;" type="radio"
               value="yes">
        <input class="overlay" name="connection-date-year" required style="top: 923px;left: 367px;width: 111px;"
               type="number">
        <input class="overlay" name="connection-date-month" required style="top: 923px;left: 517px;width: 81px;"
               type="number">
        <input class="overlay" name="peak-power" required style="top: 951px;left: 333px;width: 111px;" type="number">
        <input class="overlay square-radio" name="active-conventions" required style="top: 979px;left: 556px;"
               type="radio"
               value="no">
        <input class="overlay square-radio" name="active-conventions" required style="top: 979px;left: 636px;"
               type="radio"
               value="yes">
        <input class="overlay" name="active-conventions-list" required style="top: 1007px;left: 282px;width: 330px;">
    </div>
    <div class="pdf-page">
        <img alt="PDF Page 3" src="./template_Richiesta_Adesione_CER_files/page003.jpg">
        <input class="overlay square-radio" name="want-plant" required style="top: 117px;left: 556px;" type="radio"
               value="no">
        <input class="overlay square-radio" name="want-plant" required style="top: 117px;left: 636px;" type="radio"
               value="yes">
        <input class="overlay" name="available-surface" required style="top: 160px;left: 399px;width: 109px;"
               type="number">
        <input name="name-document" required style="position: absolute;top: 523px;left: 592px;width: 125px;"
               type="file" accept=".jpg, .jpeg, .png, .pdf">
        <input name="chamber-doc" required style="position: absolute;top: 550px;left: 592px;width: 125px;" type="file"
               accept=".jpg, .jpeg, .png, .pdf">
        <input name="electricity-bill" required style="position: absolute;top: 690px;left: 592px;width: 125px;"
               type="file" accept=".jpg, .jpeg, .png, .pdf">
        <input name="electricity-bill-prod" required style="position: absolute;top: 760px;left: 592px;width: 125px;"
               type="file" accept=".jpg, .jpeg, .png, .pdf">
        <input class="overlay" name="place" required style="top: 969px;left: 122px;width: 137px;">
        <input class="overlay" name="date" required style="top: 969px;left: 297px;width: 140px;" type="date">
        <div id="signature-parent-1" style="position: absolute;top: 900px;left: 489px;">
            <div class="signature"></div>
            <img>
            <button style="margin-top: 10px" type="button">Cancella Firma</button>
            <input class="form-control" name="signature-file"
                   style="margin:0 0 0 38px;width: 90px"
                   type="file" accept=".jpg, .jpeg, .png">
        </div>
    </div>
    <div class="pdf-page">
        <img alt="PDF Page 4" src="./template_Richiesta_Adesione_CER_files/page004.jpg">
    </div>
    <div class="pdf-page">
        <img alt="PDF Page 5" src="./template_Richiesta_Adesione_CER_files/page005.jpg">
    </div>
    <div class="pdf-page">
        <img alt="PDF Page 6" src="./template_Richiesta_Adesione_CER_files/page006.jpg">
    </div>
    <div class="pdf-page">
        <img alt="PDF Page 7" src="./template_Richiesta_Adesione_CER_files/page007.jpg">
        <input class="overlay" name="name" required style="top: 137px;left: 287px;width: 266px;">
        <input class="overlay" name="name" required style="top: 197px;left: 167px;width: 326px;">
        <input class="overlay square-radio" name="consent-1" required style="top: 266px;left: 96px;" type="radio"
               value="yes">
        <input class="overlay square-radio" name="consent-1" required style="top: 266px;left: 266px;" type="radio"
               value="no">
        <input class="overlay square-radio" name="consent-2" required style="top: 384px;left: 96px;" type="radio"
               value="yes">
        <input class="overlay square-radio" name="consent-2" required style="top: 384px;left: 266px;" type="radio"
               value="no">
        <input class="overlay square-radio" name="consent-3" required style="top: 508px;left: 96px;" type="radio"
               value="yes">
        <input class="overlay square-radio" name="consent-3" required style="top: 508px;left: 266px;" type="radio"
               value="no">
        <input class="overlay" name="place" required style="top: 850px;left: 122px;width: 137px;">
        <input class="overlay" name="date" required style="top: 850px;left: 297px;width: 140px;" type="date">
        <div id="signature-parent-2" style="position: absolute;top: 780px;left: 489px;">
            <div class="signature"></div>
            <img>
            <button style="margin-top: 10px" type="button">Cancella Firma</button>
            <input class="form-control" name="signature-file"
                   style="margin:0 0 0 38px;width: 90px"
                   type="file" accept=".jpg, .jpeg, .png">

        </div>
    </div>

    <div class="form-buttons" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);">
        <button id="clear-form" style="" type="button">Svuota</button>
        <button id="submit-form" style="" type="submit">Invia</button>
    </div>
    <input id="pdf-upload" name="pdf-upload" style="display: none">
</form>

</body>
</html>